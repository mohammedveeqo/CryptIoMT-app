"use client";

import { useState } from "react";
import { useQuery, useMutation } from "convex/react";
import { api } from "../../../../convex/_generated/api";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Textarea } from "@/components/ui/textarea";
import { toast } from "sonner";
import { Loader2, Save, CheckSquare, Square } from "lucide-react";
import { Id } from "../../../../convex/_generated/dataModel";

interface VulnerabilityDetailsProps {
  cve: any;
  organizationId: Id<"organizations">;
}

export function VulnerabilityDetails({ cve, organizationId }: VulnerabilityDetailsProps) {
  const devices = useQuery(api.cves.getDevicesForCVE, 
    cve ? { organizationId, cveId: cve._id } : "skip"
  );
  const updateStatus = useMutation(api.cves.updateDeviceCVEStatus);
  const bulkUpdate = useMutation(api.cves.bulkUpdateDeviceCVEStatus);

  const [selectedDevices, setSelectedDevices] = useState<Set<string>>(new Set());
  const [bulkStatus, setBulkStatus] = useState<string>("");
  const [bulkNotes, setBulkNotes] = useState<string>("");
  const [isBulkUpdating, setIsBulkUpdating] = useState(false);
  
  // Per-row notes editing state
  const [editingNoteId, setEditingNoteId] = useState<string | null>(null);
  const [noteContent, setNoteContent] = useState("");

  const startEditingNote = (deviceId: string, currentNote: string) => {
    setEditingNoteId(deviceId);
    setNoteContent(currentNote || "");
  };

  const saveNote = async (deviceId: Id<"medicalDevices">) => {
    try {
        await updateStatus({
            deviceId,
            cveId: cve._id,
            status: devices?.find((d: any) => d._id === deviceId)?.linkStatus || "active",
            notes: noteContent
        });
        setEditingNoteId(null);
        toast.success("Note updated");
    } catch (error) {
        toast.error("Failed to save note");
    }
  };

  const toggleSelect = (id: string) => {
    const newSet = new Set(selectedDevices);
    if (newSet.has(id)) newSet.delete(id);
    else newSet.add(id);
    setSelectedDevices(newSet);
  };

  const toggleSelectAll = () => {
    if (selectedDevices.size === devices?.length) {
      setSelectedDevices(new Set());
    } else {
      setSelectedDevices(new Set(devices?.map(d => d._id)));
    }
  };

  const handleStatusChange = async (deviceId: Id<"medicalDevices">, status: string) => {
    try {
      await updateStatus({
        deviceId,
        cveId: cve._id,
        status,
      });
      toast.success("Status updated");
    } catch (error) {
      toast.error("Failed to update status");
    }
  };

  const handleBulkUpdate = async () => {
    if (!bulkStatus) return;
    setIsBulkUpdating(true);
    try {
        // If all selected, use the bulk mutation (optimized)
        // Actually the bulk mutation in backend updates ALL for that CVE. 
        // If we want to update only selected, we should loop or add a list arg to bulk mutation.
        // The current bulkUpdateDeviceCVEStatus updates ALL devices for that CVE in the org.
        // Let's check if we selected all.
        
        if (selectedDevices.size === devices?.length) {
             await bulkUpdate({
                cveId: cve._id,
                organizationId,
                status: bulkStatus,
                notes: bulkNotes
            });
        } else {
            // Update individually for selected
            // This might be slow for many devices, but fine for now.
            // Ideally backend should support list of deviceIds.
             await Promise.all(Array.from(selectedDevices).map(deviceId => 
                updateStatus({
                    deviceId: deviceId as Id<"medicalDevices">,
                    cveId: cve._id,
                    status: bulkStatus,
                    notes: bulkNotes
                })
            ));
        }
       
        toast.success(`Updated ${selectedDevices.size} devices`);
        setSelectedDevices(new Set());
        setBulkStatus("");
        setBulkNotes("");
    } catch (error) {
        toast.error("Bulk update failed");
    } finally {
        setIsBulkUpdating(false);
    }
  };

  if (!devices) {
    return <div className="flex justify-center p-8"><Loader2 className="h-8 w-8 animate-spin" /></div>;
  }

  return (
    <div className="space-y-6">
      <div className="bg-muted/30 p-4 rounded-lg">
        <h3 className="font-semibold mb-2">Description</h3>
        <p className="text-sm text-muted-foreground">{cve.description}</p>
        <div className="mt-4 flex gap-4 text-sm">
             <div>
                <span className="font-medium">Published:</span> {new Date(cve.published).toLocaleDateString()}
             </div>
             <div>
                <span className="font-medium">CVSS Score:</span> {cve.cvssScore}
             </div>
             {cve.references && cve.references.length > 0 && (
                 <div>
                     <a href={cve.references[0]} target="_blank" rel="noopener noreferrer" className="text-blue-500 hover:underline">
                        View Reference
                     </a>
                 </div>
             )}
        </div>
      </div>

      <div className="flex items-end gap-4 p-4 border rounded-lg bg-card">
        <div className="space-y-2 flex-1">
            <label className="text-sm font-medium">Bulk Action ({selectedDevices.size} selected)</label>
            <div className="flex gap-2">
                <Select value={bulkStatus} onValueChange={setBulkStatus}>
                    <SelectTrigger className="w-[180px]">
                        <SelectValue placeholder="Set Status..." />
                    </SelectTrigger>
                    <SelectContent>
                        <SelectItem value="active">Active</SelectItem>
                        <SelectItem value="mitigated">Mitigated</SelectItem>
                        <SelectItem value="patched">Patched</SelectItem>
                        <SelectItem value="accepted">Accepted Risk</SelectItem>
                    </SelectContent>
                </Select>
                <div className="flex-1">
                     <Textarea 
                        placeholder="Add note for selected devices (optional)..." 
                        value={bulkNotes}
                        onChange={(e) => setBulkNotes(e.target.value)}
                        className="h-10 min-h-[40px] py-2 resize-none"
                     />
                </div>
                <Button 
                    disabled={selectedDevices.size === 0 || !bulkStatus || isBulkUpdating}
                    onClick={handleBulkUpdate}
                >
                    {isBulkUpdating && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                    Apply
                </Button>
            </div>
        </div>
      </div>

      <div className="border rounded-lg">
        <Table>
          <TableHeader>
            <TableRow>
              <TableHead className="w-[50px]">
                <Button variant="ghost" size="sm" onClick={toggleSelectAll}>
                    {selectedDevices.size === devices.length && devices.length > 0 ? 
                        <CheckSquare className="h-4 w-4" /> : 
                        <Square className="h-4 w-4" />
                    }
                </Button>
              </TableHead>
              <TableHead>Device Name</TableHead>
              <TableHead>Model</TableHead>
              <TableHead>Current Status</TableHead>
              <TableHead>Notes</TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {devices.map((device: any) => (
              <TableRow key={device._id}>
                <TableCell>
                    <Button variant="ghost" size="sm" onClick={() => toggleSelect(device._id)}>
                        {selectedDevices.has(device._id) ? 
                            <CheckSquare className="h-4 w-4" /> : 
                            <Square className="h-4 w-4" />
                        }
                    </Button>
                </TableCell>
                <TableCell className="font-medium">{device.name}</TableCell>
                <TableCell>{device.model}</TableCell>
                <TableCell>
                    <Select 
                        defaultValue={device.linkStatus || 'active'} 
                        onValueChange={(val) => handleStatusChange(device._id, val)}
                    >
                        <SelectTrigger className="w-[140px] h-8">
                            <SelectValue />
                        </SelectTrigger>
                        <SelectContent>
                            <SelectItem value="active">Active</SelectItem>
                            <SelectItem value="mitigated">Mitigated</SelectItem>
                            <SelectItem value="patched">Patched</SelectItem>
                            <SelectItem value="accepted">Accepted Risk</SelectItem>
                        </SelectContent>
                    </Select>
                </TableCell>
                <TableCell>
                    {editingNoteId === device._id ? (
                        <div className="flex gap-2">
                            <Textarea 
                                value={noteContent} 
                                onChange={(e) => setNoteContent(e.target.value)}
                                className="h-20"
                            />
                            <div className="flex flex-col gap-1">
                                <Button size="sm" onClick={() => saveNote(device._id)}><Save className="h-4 w-4" /></Button>
                                <Button size="sm" variant="ghost" onClick={() => setEditingNoteId(null)}>âœ•</Button>
                            </div>
                        </div>
                    ) : (
                        <div className="group relative">
                            <span className="text-sm text-muted-foreground truncate max-w-[200px] block">
                                {device.linkNotes || '-'}
                            </span>
                            <Button 
                                variant="ghost" 
                                size="sm" 
                                className="absolute right-0 top-0 opacity-0 group-hover:opacity-100 h-6 w-6 p-0"
                                onClick={() => startEditingNote(device._id, device.linkNotes)}
                            >
                                <Save className="h-3 w-3" />
                            </Button>
                        </div>
                    )}
                </TableCell>
              </TableRow>
            ))}
          </TableBody>
        </Table>
      </div>
    </div>
  );
}
